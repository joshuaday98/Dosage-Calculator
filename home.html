<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Dosage Calculator</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.1/css/bootstrap-select.min.css">
    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/jquery-ui-timepicker-addon/1.6.3/jquery-ui-timepicker-addon.min.css' />
    <link rel='stylesheet' href='static/home.css'/>
  </head>
  <body>
    <main>
      <section id='menu' class='menu col-sm-3'>
        <h1>Dosage-Calculator</h1>
        <hr />
        <form action='javascript:;' onSubmit='handleIt()' id='dose_form' method='post' name=''>
          <!--
          1: Type of ingestion
          2: Users current weight
          3: Caloric intake of the user while on their cycle
          4: If the user is split dosing
          5: Same dose & Time of dose
          6: Cycle Length
          7: Dose amount & time of dose per cycle length
          -->
          <!-- 1 -->
          <h3>Type:</h3>
          <input type='radio' name='type' value='0.8933' required/>Crystal<br />
          <input type='radio' name='type' value='1' required/>Powder
          <!-- 2 -->
          <h3>Weight:</h3>
          <input type='number' name='weight' placeholder="Your weight here" pattern='^[0-9]{3}$' required/>
          <input type='radio' name='weight-unit' value='lbs' required/> Lbs
          <input type='radio' name='weight-unit' value='kg' required/>Kg
          <!-- 3 -->
          <h3>Calories:</h3>
          <small class='form-text text-muted'>Your caloric intake while on your cycle (in Kcal).</small><br />
          <input type='number' name='cal-intake' placeholder='Kcal' min='1' pattern='^[0-9]{4}$' required/>
          <small class='form-text text-muted'>Your average caloric expenditure daily</small>
          <input type='number' name='cal-export' placeholder='Kcal' min='1' pattern='^[0-9]{4}$' required/>
          <!-- 4 -->
          <h3>Split dosing:</h3>
          <radiogroup id='daily-conditional'>
            <input id='split-yes' type='radio' name='split-dose' value='yes' onchange='$("#doses-daily").fadeIn();' required/>Yes
            <input id='split-no' type='radio' name='split-dose' value='no' onchange='$("#doses-daily").fadeOut();' required/>No
          </radiogroup>
          <div id='doses-daily' style='display:none'>
            <small class='form-text'>How many doses per day?</small>
            <select name='doses-daily' form='dose_form'>
              <option value='2'>2</option>
              <option value='3'>3</option>
              <option value='4'>4</option>
              <option value='5'>5</option>
            </select>
          </div>
          <!-- 5 -->
          <h3> Same dose & Time of Dose:</h3>
          <small class='form-text text-muted'>Will you be taking the same dose at the same time each day?</small><br />
          <radiogroup id='samedose-time'>
            <input type='radio' name='samedose-time' value='yes' required />Yes
            <input type='radio' name='samedose-time' value='no' required />No
          </radiogroup>
          <!-- 6 -->
          <h3>Cycle Length:</h3>
          Days: <input type='number' name='cycle-length' placeholder="Cycle length" min='1' pattern='^[0-9]{3}' required/>
          <br />
          <button id='cont-btn' class='cont btn btn-primary' >Continue</button>
          <!-- 7 -->
          <div id='dosing-amounts'></div>
          <div id='submit'></div>
        </form>
      </section>
      <section class='col-sm-9'>

      </section>
    </main>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src='https://cdn.jsdelivr.net/jquery.ui.timepicker.addon/1.4.5/jquery-ui-sliderAccess.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery-ui-timepicker-addon/1.6.3/jquery-ui-timepicker-addon.min.js'></script>
    <script src='static/home.js'></script>
    <script type='text/javascript'>


    function calculations(form_data){
      /*
      C(t) = C(o)^-rt
      C(t) = blood concentration @ time
      r = half life (1/36)
      t = time in hours
      */
      // TODO: while t != time between doses append concentration to array increments by .25
      if($('#dose_form').attr('name') == 'form-ny'){
        var t = 0.30, o = formdata.dose_info[0][0], r = 1/36;
        var e = Math.pow(10, (-1 * (r * t)));

        var concentration_fifteen = [];

        while(t != 24.50){
          var concentration = (o * e);
          concentration = concentration * form_data.type;
          concentration = concentration + (concentration_fifteen.length >= 1 ? concentration_fifteen[concentration_fifteen.length - 1]:0);

          concentration_fifteen.push(concentration);
          t += 0.25;
        };
      } else if($('#dose_form').attr('name') == 'form-yy'){
        var data = formdata.dose_info;
        var concentration_fifteen = [];
        
        $.each(data, function(i, v){
          var next_time = v[0] - data[i + 1][0]
          var t = 0.30, o = v[1], r = 1/36;
          var e = Math.pow(10, (-1 * (r * t)));

          while(t != v[0]){
            var concentration = o * e;
            concentration = concentration * form_data.type;
            concentration = concentration + (concentration_fifteen.length >= 1 ? concentration_fifteen[concentration_fifteen.length - 1]:0);
          };
        });
      };
    };


    function handleIt(){
      var form_data = {'type':$('input[name=type]:checked').val(),
                       'weight':{'amount':$('input[name=weight]').val(),
                                 'unit':$('input[name=weight-unit]:checked').val()},
                       'calories':{'ci':$('input[name=cal-intake]').val(),
                                   'ce':$('input[name=cal-export]').val()},
                       'cycle':$('input[name=cycle-length]').val()}

      var doses = $("input[name='dose']").map(function(){return $(this).val();}).get();
      var dose_time = $("input[name='time']").map(function(){var time_str = $(this).val();
                                                             time_str = time_str.split(':');
                                                             var hour = time_str[0];
                                                             var min = (Number(time_str[1]) * 60)
                                                             min = min / 3600
                                                             return hour + min;
                                                             }).get();
      var day = 0;

      var dose_info_array = doses.map(function (e, i){
        if($('#dose_form').attr('name') === 'form-nn'){
          day++;
          return {day:{'dose':e, 'time':dose_time[i]}};
        }else{
          return {'dose':e, 'time':dose_time[i]};
        }
      });
      $.extend(form_data, {'dose_info':dose_info_array});
      console.log(form_data);
      calculations(form_data);
    };

    </script>
  </body>
</html>
