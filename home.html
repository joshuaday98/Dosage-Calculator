<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Dosage Calculator</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.1/css/bootstrap-select.min.css">
    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/jquery-ui-timepicker-addon/1.6.3/jquery-ui-timepicker-addon.min.css' />
    <link rel='stylesheet' href='static/home.css'/>
  </head>
  <body>
    <main>
      <section id='menu' class='menu col-sm-3'>
        <h1>Dosage-Calculator</h1>
        <hr />
        <form action='javascript:;' onSubmit='handleIt()' id='dose_form' method='post' name=''>
          <!--
          0.5: JS for form handling
          1: Type of ingestion
          2: Users current weight
          3: Caloric intake of the user while on their cycle
          4: If the user is split dosing
          5: Same dose & Time of dose
          6: Cycle Length
          7: Dose amount & time of dose per cycle length
          -->
          <!-- 0.5 -->
          <script type='text/javascript'>

          'use strict';


          function chartcreation(blood_concen, time_labels){
            var chart = $('#graph')

            var myChart = new Chart(chart, {
              type:'line',
              data:{
                      labels: time_labels,
                      datasets: [
                                  {
                                      label: "Blood Concentration",
                                      fill: true,
                                      lineTension: 0.1,
                                      backgroundColor: "rgba(75,192,192,0.4)",
                                      borderColor: "rgba(75,192,192,1)",
                                      borderCapStyle: 'butt',
                                      borderDash: [],
                                      borderDashOffset: 0.0,
                                      borderJoinStyle: 'miter',
                                      pointBorderColor: "rgba(75,192,192,1)",
                                      pointBackgroundColor: "#fff",
                                      pointBorderWidth: 1,
                                      pointHoverRadius: 5,
                                      pointHoverBackgroundColor: "rgba(75,192,192,1)",
                                      pointHoverBorderColor: "rgba(220,220,220,1)",
                                      pointHoverBorderWidth: 2,
                                      pointRadius: 1,
                                      pointHitRadius: 10,
                                      data: blood_concen,
                                      spanGaps: true,
                                  }
                                ]
                              },

            });
          };


          function format_time(inp){
            inp = inp.toString();
            inp = inp.split('.');
            var hour = Number(inp[0]), min= (Number(inp[1])* 60) / 100;

            hour > 24 ? hour -= 24 : hour = hour;
            isNaN(min) ? min = '00' : min = min.toString();

            var time_str = hour.toString() + ':' + min.toString() + (min == '3' ? '0' : '');
            return time_str
          };

          function calculations(form_data){
              /*
              C(t) = C(o)^-rt
              C(t) = blood concentration @ time
              r = half life (1/36)
              t = time in hours
              */

              var concentrations = [];
              var times = [];

              if($('#dose_form').attr('name') == 'form-ny'){
                var t = 0, o = form_data.dose_info[0].dose, r = 1/36;
                var label_time = form_data.dose_info[0].time;
                var days = 0
                var next_time = 24.50
                var end_concent = 0

                // TODO: MAKE IT WORK
                while(days != form_data.cycle){
                  while(t < next_time){
                    var len = concentrations.length
                    len % 25 == 0 ? (o += concentrations[len - 1], end_concent += concentrations[len - 1]):o += 0;
                    var e = Math.pow(10, (-1 * (r * t)));
                    var concentration = (o * e);
                    concentration = concentration * form_data.type;

                    concentrations.push(concentration); times.push(format_time(label_time));
                    label_time += 1;
                    t += 1;
                  };
                  label_time = 0;
                  t = 0;
                  days += 1;
                };
              } else if($('#dose_form').attr('name') == 'form-yy'){
                var data = form_data.dose_info;

                $.each(data, function(i, v){
                  var next_time = v.time - data[i++].time
                  var t = 0, o = v.dose, r = 1/36;

                  while(t != next_time){
                    var e = Math.pow(10, (-1 * (r * t)));
                    var concentration = o * e;
                    concentration = concentration * form_data.type;
                    concentration = concentration + (t + 0.25 == next_time ? concentrations[concentrations.length - 1]:0).toFixed(4);
                    concentration.push(concentration); times.push(label_time);
                    t += 0.25; label_time += 0.25;
                  };
                });
              } else{
                var data = form_data.dose_info;

                $.each(data, function(i, v){
                  var next_time = v.time - data[i++].time, t = 0, o = v.dose, r = 1/36;

                  while(t != next_time){
                    var e = Math.pow(10, (-1 * (r * t)));
                    var concentration = o * e;
                    concentration = concentration * form_data.type;
                    concentration= concentration + (t + 0.25 == next_time ? concentrations[concentrations.length - 1]:0);
                    concentration.push(concentration); times.push(label_time);
                    t += 0.25; label_time += 0.25;
                  };
                });
              };
              console.log(concentration, times)
              chartcreation(concentration, times)
            };


            function handleIt(){
              var form_data = {'type':Number($('input[name=type]:checked').val()),
                               'weight':{'amount':Number($('input[name=weight]').val()),
                                         'unit':$('input[name=weight-unit]:checked').val()},
                               'calories':{'ci':Number($('input[name=cal-intake]').val()),
                                           'ce':Number($('input[name=cal-export]').val())},
                               'cycle':Number($('input[name=cycle-length]').val())}

              var doses = $("input[name='dose']").map(function(){return Number($(this).val());}).get();
              var dose_time = $("input[name='time']").map(function(){var time_str = $(this).val();
                                                                     time_str = time_str.split(':');
                                                                     var hour = time_str[0];
                                                                     var min = (Number(time_str[1]) * 60)
                                                                     min = min / 3600
                                                                     return Number(hour) + Number(min);
                                                                     }).get();
              var day = 0;

              var dose_info_array = doses.map(function (e, i){
                if($('#dose_form').attr('name') === 'form-nn'){
                  day++;
                  return {day:{'dose':e, 'time':dose_time[i]}};
                }else{
                  return {'dose':e, 'time':dose_time[i]};
                }
            });
            $.extend(form_data, {'dose_info':dose_info_array});
            console.log(form_data);
            calculations(form_data);
          };
          </script>
          <!-- 1 -->
          <h3>Type:</h3>
          <input type='radio' name='type' value='0.8933' required/>Crystal<br />
          <input type='radio' name='type' value='1' required/>Powder
          <!-- 2 -->
          <h3>Weight:</h3>
          <input type='number' name='weight' placeholder="Your weight here" pattern='^[0-9]{3}$' required/>
          <input type='radio' name='weight-unit' value='lbs' required/> Lbs
          <input type='radio' name='weight-unit' value='kg' required/>Kg
          <!-- 3 -->
          <h3>Calories:</h3>
          <small class='form-text text-muted'>Your caloric intake while on your cycle (in Kcal).</small><br />
          <input type='number' name='cal-intake' placeholder='Kcal' min='1' pattern='^[0-9]{4}$' required/>
          <small class='form-text text-muted'>Your average caloric expenditure daily</small>
          <input type='number' name='cal-export' placeholder='Kcal' min='1' pattern='^[0-9]{4}$' required/>
          <!-- 4 -->
          <h3>Split dosing:</h3>
          <radiogroup id='daily-conditional'>
            <input id='split-yes' type='radio' name='split-dose' value='yes' onchange='$("#doses-daily").fadeIn();' required/>Yes
            <input id='split-no' type='radio' name='split-dose' value='no' onchange='$("#doses-daily").fadeOut();' required/>No
          </radiogroup>
          <div id='doses-daily' style='display:none'>
            <small class='form-text'>How many doses per day?</small>
            <select name='doses-daily' form='dose_form'>
              <option value='2'>2</option>
              <option value='3'>3</option>
              <option value='4'>4</option>
              <option value='5'>5</option>
            </select>
          </div>
          <!-- 5 -->
          <h3> Same dose & Time of Dose:</h3>
          <small class='form-text text-muted'>Will you be taking the same dose at the same time each day?</small><br />
          <radiogroup id='samedose-time'>
            <input type='radio' name='samedose-time' value='yes' required />Yes
            <input type='radio' name='samedose-time' value='no' required />No
          </radiogroup>
          <!-- 6 -->
          <h3>Cycle Length:</h3>
          Days: <input type='number' name='cycle-length' placeholder="Cycle length" min='1' pattern='^[0-9]{3}' required/>
          <br />
          <button id='cont-btn' class='cont btn btn-primary' >Continue</button>
          <!-- 7 -->
          <div id='dosing-amounts'></div>
          <div id='submit'></div>
        </form>
      </section>
      <section class='col-sm-9'>
        <canvas id='graph'></canvas>
      </section>
    </main>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src='https://cdn.jsdelivr.net/jquery.ui.timepicker.addon/1.4.5/jquery-ui-sliderAccess.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery-ui-timepicker-addon/1.6.3/jquery-ui-timepicker-addon.min.js'></script>
    <script src='static/home.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.bundle.min.js'></script>

  </body>
</html>
